jQuery(document).ready((function(e){let t=[],o=[],i="",a=1,r=1,s=50,c=!1,n="",l=0,d=0,u=[];function p(){window.currentCropRequest&&(window.currentCropRequest.abort(),window.currentCropRequest=null),c=!1,g(),e(".button").prop("disabled",!1),e("#crop-selected").text("Crop Selected (40px)"),e("#live-progress").hide(),e("#detailed-progress-section").hide(),e(".crop-individual").each((function(){e(this).removeClass("failed cropping");let t=parseInt(e(this).closest(".image-item").find(".padding-input").val())||40;e(this).text("Crop ("+t+"px)")})),l=0}function g(){u.forEach((function(e){clearTimeout(e)})),u=[],window.searchTimeout&&clearTimeout(window.searchTimeout)}function m(e,t){let o=setTimeout((function(){try{e()}catch(e){p()}}),t);return u.push(o),o}function f(){d=Date.now()}function v(t,o,i,a,r=!1){c=!1,g(),e("#crop-selected").prop("disabled",!1).text("Crop Selected (40px)"),C(i,i,r?"Cancelled for safety!":"Completed!"),_(100,100,r?"Bulk crop cancelled":"Bulk crop completed"),j(r?"BULK CROP CANCELLED (FAILSAFE)":"BULK CROP COMPLETED"),j("SUMMARY: "+t+" successful, "+o+" failed out of "+i+" images (padding: "+a+"px)"),S("Bulk crop "+(r?"cancelled":"completed")+": "+t+"/"+i+" images successful ("+a+"px padding)"),m((function(){e("#live-progress").fadeOut()}),5e3),r?T("Bulk crop was cancelled for system stability. "+t+" images were processed successfully.","warning"):t===i?T("All "+i+" images cropped successfully!","success"):t>0?T(t+" of "+i+" images cropped successfully","success"):T("All crops failed. Check the detailed log for errors.","error")}function h(t,o,i,a=!1){c=!1,g(),e("#bulk-save-all-crops").prop("disabled",!1).text("ðŸ’¾ Save All Cropped Images"),C(i,i,a?"Save cancelled!":"Bulk save completed!"),_(100,100,a?"Bulk save cancelled":"Bulk save completed"),j(a?"BULK SAVE CANCELLED (FAILSAFE)":"BULK SAVE COMPLETED"),j("SUMMARY: "+t+" saved, "+o+" failed out of "+i+" images"),S("Bulk save "+(a?"cancelled":"completed")+": "+t+"/"+i+" images saved successfully"),m((function(){e("#live-progress").fadeOut()}),5e3),a?T("Bulk save was cancelled for system stability","warning"):t===i?(T("All "+i+" images saved successfully! ðŸŽ‰","success"),0===e(".crop-result-item").length&&e("#cropped-images-section").fadeOut()):t>0?T(t+" of "+i+" images saved successfully","success"):T("All saves failed. Check the detailed log for errors.","error")}function b(t,o,i){e("#cropped-images-section").show();let a=e('.image-item[data-image-id="'+t+'"]'),r=a.find(".image-title").text()||"Image "+t,s=a.closest(".product-images-group").find(".product-group-title").text()||"Unknown Product";e('.crop-result-item[data-image-id="'+t+'"]').remove();let c='<div class="crop-result-item" data-image-id="'+t+'">';c+='<div class="crop-result-preview">',c+='<img src="'+o.preview_url+'" alt="Cropped '+r+'" loading="lazy">',c+="</div>",c+='<div class="crop-result-info">',c+='<h4 title="'+r+'">'+r+"</h4>",c+='<div class="crop-result-meta">Product: '+s+"</div>",c+='<div class="crop-result-meta">ID: '+t+"</div>",c+='<div class="crop-result-meta">Size: '+o.preview_size+"</div>",c+='<div class="crop-result-meta">Padding: '+i+"px</div>",c+='<div class="crop-result-actions">',c+='<button class="button button-primary save-crop-result" data-image-id="'+t+'">Save as Original</button>',c+='<button class="button button-secondary discard-crop-result" data-image-id="'+t+'">Discard</button>',c+='<a href="'+o.preview_url+'" target="_blank" class="button button-small">View Full</a>',c+="</div>",c+="</div>",c+="</div>",e("#cropped-images-grid").prepend(c)}function w(){if(!i&&!n)return;c=!0,f(),_(0,100,"Loading products..."),e("#live-progress").show(),e("#products-grid").html('<div class="loading">Loading products...</div>');let t={action:"get_products_by_category",category_id:i,page:a,per_page:s,nonce:ajax_object.nonce};n&&(t.search_term=n),e.ajax({url:ajax_object.ajax_url,type:"POST",timeout:6e4,data:t,success:function(t){t.success?(!function(t){if(0===t.length){let t=n?'No products found for search "'+n+'"':"No products found in this category.";return void e("#products-grid").html('<div class="no-products">'+t+"</div>")}let i='<div class="products-container">';t.forEach((function(e){let t=-1!==o.indexOf(e.id),a=t?"checked":"",r=t?"selected":"",s=e.title;if(n){let t=new RegExp("("+n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+")","gi");s=e.title.replace(t,'<mark style="background: #ffeb3b; padding: 1px 2px;">$1</mark>')}i+='<div class="product-card '+r+'" data-product-id="'+e.id+'">',i+='<div class="product-checkbox-container">',i+='<input type="checkbox" class="product-checkbox" value="'+e.id+'" '+a+">",i+="</div>",i+='<div class="product-thumbnail">',e.thumbnail_url?i+='<img src="'+e.thumbnail_url+'" alt="Product thumbnail">':i+='<div class="no-image">No Image</div>',i+="</div>",i+='<div class="product-info">',i+='<h3 title="'+e.title+'">'+s+"</h3>",i+='<div class="product-meta">ID: '+e.id+" | "+e.type_label+" | "+e.image_count+" images</div>",e.price&&(i+='<div class="product-price">'+e.price+"</div>"),i+="</div>",i+="</div>"})),i+="</div>",e("#products-grid").html(i)}(t.data.products),function(t){r=t.total_pages,a=t.current_page;let o="Page "+a+" of "+r;e("#page-info").text(o),e("#product-count").text("("+t.showing+" of "+t.total_products+")")}(t.data.pagination),_(100,100,"Products loaded successfully"),m((function(){e("#live-progress").fadeOut()}),2e3)):(e("#products-grid").html('<div class="error">Failed to load products</div>'),T("Failed to load products","error"))},error:function(t,o,i){e("#products-grid").html('<div class="error">Error loading products: '+i+"</div>"),T("Error loading products: "+i,"error")},complete:function(){c=!1,x()}})}function x(){let t=a<=1||c,o=a>=r||c;e("#prev-page").prop("disabled",t),e("#next-page").prop("disabled",o)}function k(){let t=o.length;e("#selected-products-count").text(t+" products selected"),e("#load-all-selected-images").prop("disabled",0===t||c),e("#clear-selection").prop("disabled",0===t||c),t>0?(e(".selected-summary").show(),function(){let t="";o.slice(0,10).forEach((function(o){let i=e('.product-card[data-product-id="'+o+'"]');if(i.length){let e=i.find("h3").attr("title")||i.find("h3").text(),o=i.find(".product-meta").text().match(/(\d+) images/),a=o?o[1]:"0";t+='<span class="selected-product-tag" title="'+e+'">'+e.substring(0,20)+(e.length>20?"...":"")+" ("+a+")</span>"}})),o.length>10&&(t+='<span class="selected-product-tag">+'+(o.length-10)+" more...</span>");e("#selected-products-preview").html(t)}()):e(".selected-summary").hide()}function y(){let o=t.length;e("#selected-count").text(o+" selected"),e("#crop-selected").prop("disabled",0===o||c),e("#crop-selected").text("Crop Selected (40px)")}function _(t,o,i){let a=o>0?t/o*100:0;e("#mini-progress-fill").css("width",a+"%"),e("#mini-progress-text").text(i)}function C(t,o,i){let a=o>0?t/o*100:0;e("#progress-fill").css("width",a+"%"),e("#progress-text").text(t+" / "+o+" - "+i)}function j(t,o=!1){let i=(new Date).toLocaleTimeString(),a=e("#progress-log").html(),r=o?'style="color: #d63638;"':"";e("#progress-log").html("["+i+"] <span "+r+">"+t+"</span><br>"+a)}function S(t,o=!1){e("#quick-results").show();let i=e("#quick-results-content").html(),a=(new Date).toLocaleTimeString(),r=o?'style="color: #d63638;"':'style="color: #00a32a;"';e("#quick-results-content").html("["+a+"] <span "+r+">"+t+"</span><br>"+i);let s=e("#quick-results-content").html().split("<br>");s.length>5&&e("#quick-results-content").html(s.slice(0,5).join("<br>"))}function T(t,o){e(".notification").remove();let i=e('<div class="notification '+o+'">'+t+"</div>");e("body").append(i),i.fadeIn(300).delay("error"===o?8e3:5e3).fadeOut(500,(function(){e(this).remove()}))}e("#category-select").html('<option value="">Loading categories...</option>'),e.ajax({url:ajax_object.ajax_url,type:"POST",timeout:3e4,data:{action:"get_product_categories",nonce:ajax_object.nonce},success:function(t){t.success?function(t){let o='<option value="">Select a category...</option>';t.forEach((function(e){let t="all"===e.id?"":" ("+e.count+")";o+='<option value="'+e.id+'">'+e.name+t+"</option>"})),e("#category-select").html(o)}(t.data):(e("#category-select").html('<option value="">Failed to load categories</option>'),T("Failed to load categories","error"))},error:function(t,o,i){e("#category-select").html('<option value="">Error loading categories</option>'),T("Error loading categories: "+i,"error")}}),e("#category-select").on("change",(function(){c?T("Please wait for current operation to complete","warning"):(i=e(this).val(),e("#load-category-products").prop("disabled",!i),function(){if(i){let t=e("#category-select option:selected").text();e("#category-info").html("<p>Selected: <strong>"+t+"</strong></p>")}else e("#category-info").html("")}())})),e("#load-category-products").on("click",(function(){c||(a=1,w())})),e("#reset-plugin").on("click",(function(){confirm("Reset all data and start fresh?")&&(p(),g(),t=[],o=[],i="",n="",a=1,r=1,c=!1,e("#category-select").val(""),e("#search-products").val(""),e("#clear-search").hide(),e("#load-category-products").prop("disabled",!0),e("#category-info").html(""),e("#products-grid").html(""),e("#images-grid").html(""),e("#selected-products-preview").html(""),e("#cropped-images-grid").html(""),e(".selected-summary").hide(),e("#detailed-progress-section").hide(),e("#cropped-images-section").hide(),e("#live-progress").hide(),e("#quick-results").hide(),e("#product-count").text(""),e("#page-info").text("Page 1 of 1"),e("#selected-products-count").text("0 selected"),e("#selected-count").text("0 selected"),k(),y(),x(),T("Plugin reset successfully","success"))})),e("#prev-page").on("click",(function(){a>1&&!c&&(a--,w())})),e("#next-page").on("click",(function(){a<r&&!c&&(a++,w())})),e("#per-page-select").on("change",(function(){c||(s=parseInt(e(this).val()),a=1,w())})),e("#search-products").on("input",(function(){if(c)return;let t=e(this).val().trim();e("#clear-search").toggle(t.length>0),t.length>0?e(this).closest(".category-controls").addClass("search-active"):e(this).closest(".category-controls").removeClass("search-active"),(t.length>=2||0===t.length)&&(n=t,a=1,clearTimeout(window.searchTimeout),window.searchTimeout=setTimeout((function(){c||w()}),500))})),e("#clear-search").on("click",(function(){c||(e("#search-products").val("").focus(),e(".category-controls").removeClass("search-active"),n="",a=1,w(),e(this).hide())})),e(document).on("change",".product-checkbox",(function(){if(c)return e(this).prop("checked",!1),void T("Please wait for current operation to complete","warning");let t=parseInt(e(this).val()),i=e(this).closest(".product-card");if(e(this).is(":checked")){if(o.length>=3)return e(this).prop("checked",!1),void T("MoÅ¾ete selektovati maksimalno 3 proizvoda odjednom za optimalne performanse","error");-1===o.indexOf(t)&&(o.push(t),i.addClass("selected"))}else o=o.filter((e=>e!==t)),i.removeClass("selected");k()})),e("#load-all-selected-images").on("click",(function(){c?T("Please wait for current operation to complete","warning"):0!==o.length?0!==o.length&&(c=!0,f(),_(0,100,"Loading images..."),e("#live-progress").show(),e("#images-grid").html('<div class="loading">Loading images for '+o.length+" products...</div>"),t=[],y(),e.ajax({url:ajax_object.ajax_url,type:"POST",timeout:12e4,data:{action:"get_product_images",product_ids:o,nonce:ajax_object.nonce},success:function(t){t.success?(function(t,o){if(0===t.length)return void e("#images-grid").html('<div class="no-images">No images found for selected products.</div>');let i='<div class="images-info">';i+="<strong>Total Images:</strong> "+o.total_images+" from "+o.products_count+" products",i+="</div>";let a={};t.forEach((function(e){a[e.product_id]||(a[e.product_id]=[]),a[e.product_id].push(e)})),Object.keys(a).forEach((function(e){let t=a[e],o=t[0].product_name;i+='<div class="product-images-group">',i+='<div class="product-group-title">'+o+" ("+t.length+" images)</div>",i+='<div class="product-images-grid">',t.forEach((function(e){i+='<div class="image-item" data-image-id="'+e.id+'">',i+='<div class="image-checkbox-container">',i+='<input type="checkbox" class="image-checkbox" id="img_'+e.id+'" value="'+e.id+'">',i+='<label for="img_'+e.id+'">Select</label>',i+="</div>",i+='<div class="image-preview">',i+='<img src="'+e.url+'" alt="'+e.title+'" loading="lazy">',e.badge&&(i+='<div class="image-badge '+e.badge.toLowerCase()+'">'+e.badge+"</div>"),i+="</div>",i+='<div class="image-info">',i+='<div class="image-title" title="'+e.title+'">'+e.title+"</div>",i+="<p><strong>ID:</strong> "+e.id+"</p>",i+="<p><strong>Size:</strong> "+e.size+"</p>",i+='<div class="individual-padding">',i+="<label>Padding: </label>",i+='<input type="number" class="padding-input" value="40" min="0" max="200" style="width:50px;"> px',i+="</div>",i+='<div class="image-actions">',i+='<button class="button button-small crop-individual" data-image-id="'+e.id+'">Crop (40px)</button>',i+='<a href="'+e.full_url+'" target="_blank" class="button button-small">View Original</a>',i+="</div>",i+="</div>",i+="</div>"})),i+="</div>",i+="</div>"})),e("#images-grid").html(i)}(t.data.images,t.data),_(100,100,"Images loaded successfully"),m((function(){e("#live-progress").fadeOut()}),2e3)):(e("#images-grid").html('<div class="error">Failed to load images: '+(t.data||"Unknown error")+"</div>"),T("Failed to load images","error"))},error:function(t,o,i){e("#images-grid").html('<div class="error">Error loading images: '+i+"</div>"),T("Error loading images: "+i,"error")},complete:function(){c=!1}})):T("Please select products first","error")})),e("#clear-selection").on("click",(function(){c?T("Please wait for current operation to complete","warning"):(o=[],t=[],e(".product-checkbox").prop("checked",!1),e(".product-card").removeClass("selected"),e(".image-checkbox").prop("checked",!1),e("#images-grid").html(""),e(".selected-summary").hide(),k(),y(),T("All selections cleared","success"))})),e(document).on("change",".image-checkbox",(function(){if(c)return e(this).prop("checked",!1),void T("Please wait for current operation to complete","warning");let o=parseInt(e(this).val());e(this).is(":checked")?-1===t.indexOf(o)&&t.push(o):t=t.filter((e=>e!==o)),y()})),e("#select-all-images").on("click",(function(){c||e(".image-checkbox").prop("checked",!0).trigger("change")})),e("#deselect-all-images").on("click",(function(){c||e(".image-checkbox").prop("checked",!1).trigger("change")})),e(document).on("input",".padding-input",(function(){let t=e(this).closest(".image-item").data("image-id"),o=parseInt(e(this).val())||40;e('.image-item[data-image-id="'+t+'"] .crop-individual').text("Crop ("+o+"px)")})),e(document).on("click",".crop-individual",(function(){if(c)return void T("Please wait for current operation to complete","warning");let t=e(this).data("image-id"),o=e(this).closest(".image-item").find(".padding-input");!function(t,o,i){if(c)return void T("System busy - please wait","warning");c=!0,f(),i.prop("disabled",!0).text("Cropping..."),_(0,100,"Creating cropped version..."),e("#live-progress").show();let a=Date.now(),r=!1,s=setTimeout((function(){r||(r=!0,c=!1,i.prop("disabled",!1).text("Emergency Stop").addClass("failed"),_(100,100,"Emergency stop activated"),T("Emergency stop - system protected","error"),g())}),7e4),n=setTimeout((function(){r||(r=!0,clearTimeout(s),i.text("Timeout").addClass("failed"),_(100,100,"Operation timeout"),T("Crop timeout - try smaller image","warning"),setTimeout((function(){if(c=!1,i.prop("disabled",!1),!i.hasClass("failed")){let e=parseInt(i.closest(".image-item").find(".padding-input").val())||40;i.text("Crop ("+e+"px)")}}),2e3))}),6e4),l=setInterval((function(){Date.now()-a>5e4&&!r&&_(90,100,"Operation taking longer than expected..."),r&&clearInterval(l)}),5e3);e.ajax({url:ajax_object.ajax_url,type:"POST",timeout:55e3,data:{action:"preview_crop",image_id:t,padding:o,nonce:ajax_object.nonce},beforeSend:function(e){window.currentCropRequest=e},success:function(a){if(!r)if(clearTimeout(n),clearTimeout(s),clearInterval(l),a.success){let r=a.data;b(t,r,o),i.text("Crop ("+o+"px)").removeClass("cropping failed"),_(100,100,"Cropped version created"),S("Cropped version created for image "+t+" ("+o+"px padding)"),setTimeout((function(){e("#live-progress").fadeOut()}),2e3)}else{i.text("Crop Failed").addClass("failed"),_(100,100,"Crop failed");let e=a.data?.message||"Unknown error";S("Crop failed for image "+t+": "+e,!0)}},error:function(e,o,a){if(r)return;clearTimeout(n),clearTimeout(s),clearInterval(l),i.text("Error").addClass("failed"),_(100,100,"Error occurred");let c=a;"timeout"===o?c="Server timeout - shared hosting limit":500===e.status?c="Server error - check resources":0===e.status&&(c="Connection error"),S("Crop error for image "+t+": "+c,!0)},complete:function(e,t){clearTimeout(n),clearTimeout(s),clearInterval(l),window.currentCropRequest===e&&(window.currentCropRequest=null),setTimeout((function(){if(c=!1,i.prop("disabled",!1),!r&&!i.hasClass("failed")){let e=parseInt(i.closest(".image-item").find(".padding-input").val())||40;i.text("Crop ("+e+"px)")}}),1e3)}}),u.push(n),u.push(s),u.push(l)}(t,parseInt(o.val())||40,e(this))})),e("#crop-selected").on("click",(function(){c?T("Please wait for current operation to complete","warning"):0!==t.length?t.length>20?T("Molim vas selektujte maksimalno 20 slika za stabilnost sistema","error"):confirm("Crop "+t.length+" selected images with 40px padding (recommended)?")&&function(o){if(c)return;c=!0,f(),l=0,e("#detailed-progress-section").show(),e("#crop-selected").prop("disabled",!0).text("Cropping..."),_(0,100,"Starting bulk crop..."),e("#live-progress").show();let i=t.length,a=0,r=0,s=0,n=Math.ceil(.4*i),d=m((function(){c&&(p(),T("Bulk crop cancelled after 8 minutes for server stability","error"),v(r,s,i,o,!0))}),48e4);function u(){if(f(),s>=n)return clearTimeout(d),void v(r,s,a,o,!0);if(a>=i)return clearTimeout(d),void v(r,s,i,o);let c=t[a],l=a+1;C(l,i,"Cropping image ID: "+c),_(l,i,"Processing "+l+"/"+i),j("Processing image "+c+" ("+l+"/"+i+")");let p=m((function(){s++,a++,j("Image "+c+" timeout (failsafe)",!0),m(u,1500)}),75e3);e.ajax({url:ajax_object.ajax_url,type:"POST",timeout:6e4,data:{action:"preview_crop",image_id:c,padding:o,nonce:ajax_object.nonce},success:function(e){clearTimeout(p),e.success?(r++,b(c,e.data,o),j("Image "+c+" cropped successfully")):(s++,j("Image "+c+" failed: "+(e.data?.message||"Unknown error"),!0))},error:function(e,t,o){clearTimeout(p),s++,j("Image "+c+" error: "+o,!0)},complete:function(){a++,m(u,1200)}})}u()}(40):T("Please select images to crop","error")})),e(document).on("click",".save-crop-result",(function(){if(c)return void T("Please wait for current operation to complete","warning");let o=e(this).data("image-id");confirm("Save this cropped version as the original image? This will replace the current image.")&&function(o,i){if(c)return;c=!0,f(),i.prop("disabled",!0).text("Saving..."),_(0,100,"Saving as original image..."),e("#live-progress").show();let a=m((function(){c&&(i.text("Timeout").addClass("failed"),p(),T("Save timeout - operation cancelled","error"))}),6e4);e.ajax({url:ajax_object.ajax_url,type:"POST",timeout:45e3,data:{action:"commit_preview",image_id:o,nonce:ajax_object.nonce},success:function(r){if(clearTimeout(a),r.success){e('.crop-result-item[data-image-id="'+o+'"]').fadeOut(500,(function(){e(this).remove()}));let a=e('.image-item[data-image-id="'+o+'"]');a.addClass("removing"),m((function(){a.remove(),t=t.filter((e=>e!==o)),y();let i=e("#img_"+o);i.is(":checked")&&i.prop("checked",!1),T("Image "+o+" saved and removed from list âœ…","success")}),500),i.text("Saved").addClass("success"),_(100,100,"Image saved successfully"),S("Image "+o+" saved as original and removed from workflow"),m((function(){e("#live-progress").fadeOut()}),2e3)}else i.text("Save Failed").addClass("failed"),_(100,100,"Save failed"),S("Save failed for image "+o+": "+(r.data?.message||"Unknown error"),!0)},error:function(e,t,r){clearTimeout(a),i.text("Error").addClass("failed"),_(100,100,"Error occurred"),S("Save error for image "+o+": "+r,!0)},complete:function(){clearTimeout(a),c=!1,m((function(){i.prop("disabled",!1),i.hasClass("success")||i.hasClass("failed")||i.text("Save")}),3e3)}})}(o,e(this))})),e(document).on("click",".discard-crop-result",(function(){c?T("Please wait for current operation to complete","warning"):function(t){e.ajax({url:ajax_object.ajax_url,type:"POST",timeout:1e4,data:{action:"discard_preview",image_id:t,nonce:ajax_object.nonce},success:function(o){e('.crop-result-item[data-image-id="'+t+'"]').fadeOut(500,(function(){e(this).remove()})),T("Cropped result discarded","success")},error:function(){T("Failed to discard result","error")}})}(e(this).data("image-id"))})),e(document).on("click","#bulk-save-all-crops",(function(){if(c)return void T("Please wait for current operation to complete","warning");let o=e(".crop-result-item");0!==o.length?confirm("Save ALL "+o.length+" cropped images as originals? This will replace current images permanently.")&&function(){if(c)return;c=!0,f(),e("#detailed-progress-section").show(),e("#bulk-save-all-crops").prop("disabled",!0).text("Saving All..."),_(0,100,"Starting bulk save..."),e("#live-progress").show();let o=e(".crop-result-item"),i=[];o.each((function(){i.push(parseInt(e(this).data("image-id")))}));let a=i.length,r=0,s=0,n=0,l=m((function(){c&&(p(),T("Bulk save cancelled for system safety","error"),h(s,n,a,!0))}),3e5);function d(){if(f(),r>=a)return clearTimeout(l),void h(s,n,a);let o=i[r],c=r+1;C(c,a,"Saving image ID: "+o),_(c,a,"Saving "+c+"/"+a),j("Saving image "+o+" ("+c+"/"+a+")"),e.ajax({url:ajax_object.ajax_url,type:"POST",timeout:6e4,data:{action:"commit_preview",image_id:o,nonce:ajax_object.nonce},success:function(i){if(i.success){s++,e('.crop-result-item[data-image-id="'+o+'"]').fadeOut(300,(function(){e(this).remove()}));let i=e('.image-item[data-image-id="'+o+'"]');i.addClass("removing"),m((function(){i.remove(),t=t.filter((e=>e!==o)),y()}),300),j("Image "+o+" saved successfully")}else n++,j("Image "+o+" failed: "+(i.data?.message||"Unknown error"),!0)},error:function(e,t,i){n++,j("Image "+o+" error: "+i,!0)},complete:function(){r++,m(d,500)}})}d()}():T("No cropped images to save","error")})),e("#toggle-detailed-log").on("click",(function(){e("#progress-log").toggle()})),wp.heartbeat.enqueue("bulk_cropper_heartbeat",!0,!0),e(document).on("heartbeat-send",(function(e,t){c&&(t.bulk_cropper_heartbeat=!0)})),e(document).on("heartbeat-tick",(function(e,t){t.bulk_cropper_heartbeat&&t.bulk_cropper_heartbeat})),setInterval((function(){c&&Date.now()-d>3e5&&(p(),T("System auto-reset after timeout","warning"))}),3e4),window.addEventListener("error",(function(e){e.message&&e.message.includes("bulk-cropper")&&p()})),window.addEventListener("beforeunload",(function(){g(),p()})),window.addEventListener("beforeunload",(function(e){if(c)return window.currentCropRequest&&window.currentCropRequest.abort(),g(),p(),e.preventDefault(),"Crop operation in progress. Are you sure you want to leave?"})),window.addEventListener("error",(function(e){e.message&&e.message.includes("bulk-cropper")&&(p(),T("System error detected - resetting for safety","warning"))}))}));